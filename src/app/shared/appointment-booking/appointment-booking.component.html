<form 
    [formGroup]="form" 
    (ngSubmit)="onSubmit(form.value, form.valid)" 
    novalidate 
    class="mb-0">

    <div 
        fxLayout="row" 
        *ngIf="isEditVisible" 
        fxLayoutAlign="space-around center" 
        style="height:100%; position: relative; margin-left: 50%; margin-right: 50%;">
        <mat-spinner diameter="50" strokeWidth="5"></mat-spinner>
    </div>

    <div [ngClass]="isEditVisible ? 'd-none' : ''">

        <div class="row">

            <div class="col-lg-12">

                <input 
                    type="hidden"
                    formControlname="_id">

                <div class="row">

                    <div class="col-lg-3 col-sm-4 col-4">
                        <label class="col-form-label">
                            {{getLang('attendee', 'Attendee')}}
                            <span class="text-danger">*</span>
                        </label>
                        <mat-form-field class="mat-form-field-space-remove" >
                            <mat-select 
                                formControlName="assign" 
                                (selectionChange)="onAssignChanged($event.value)">
                                <mat-option 
                                    *ngFor="let assign of assignLists" 
                                    [value]="assign.id">
                                    {{assign.name}} 
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>

                    <div class="col-lg-9 col-sm-8 col-8" *ngIf="type == 'multi'">
                        
                        <label class="col-form-label">
                        &nbsp;
                        </label>
                        
                        <div  *ngIf="assign=='individual'">

                            <div class="row">
                                
                                <div class="col-sm-10">
                                    <div class="input-group align-items-center">
                                       <div class="flex-grow-1">
                                    <mat-form-field class="example-full-width mat-form-field-space-remove" appearance="standard" >
                                        <input 
                                            #myInput
                                            type="text"
                                            matInput
                                            required
                                            placeholder="Search Customer"
                                            [formControl]="attendee"
                                            [matAutocomplete]="autoAttendee"
                                            (focusout)="focusLostAttendeeSelected(myInput.value)"
                                            (change)="handleEmptyAttendeeInput($event)">            
                                        <mat-autocomplete 
                                            #autoAttendee="matAutocomplete"
                                            [displayWith]="displayAttendeeFn"
                                            (optionSelected)="optionAttendeeSelected($event.option.value)">
                        
                                            <mat-option *ngIf="attendeeisLoadingBox" class="is-loading">
                                                <mat-spinner diameter="50"></mat-spinner>
                                            </mat-option>                        
                                            <mat-option 
                                                *ngFor="let option of filteredAttendeeOptions" 
                                                [value]="option" >
                                                {{option?.nickname}}
                                            </mat-option>            
                                        </mat-autocomplete>
                                        
                                    </mat-form-field>
                                  </div> 
                                    <div class="d-flex align-items-center" [ngClass]="!newCustomer && attendee && attendee.value && attendee.value._id ? 'd-block' : 'd-none'">
                                                                                                                  
                                                <mat-checkbox 
                                                    class="example-margin" 
                                                    formControlName="isattendeeemail"
                                                    (change)="sendMailChange($event)"> 
                                                </mat-checkbox>
                                                <i class="material-icons mt-minus-3">email</i>                                       
                                    </div>

                                  </div>
                                </div>

                                <div class="col-sm-2">
                                    <button 
                                        (click)="addNewCustomer()"
                                        mat-button
                                        type="button"
                                        [disabled]="attendee.disabled"
                                        class="btn btn-primary btn-simple btn-square-plr"
                                        matTooltip="Add Customer">
                                        <i class="material-icons help-font">add</i>
                                    </button>
                                </div>
                            </div>
                                
                            <div 
                                [hidden]="form.get('attendee').valid || (form.get('attendee').pristine && !submitted)"
                                class="text-danger">
                                <small *ngIf="form.get('attendee').hasError('required')" class="error-label">
                                    {{getLang('attendeeisrequired', 'Attendee is Required')}}
                                </small>
                            </div>

                            <p class="text-warning" *ngIf="this.attendee && this.attendee.value && this.attendee.value._id && this.noshowAlert">
                                Client has recent no show appointment
                            </p>
                
                        </div>

                        <div *ngIf="assign=='group'">
                           <div class="input-group align-items-center">
                            <div class="flex-grow-1">
                            <mat-form-field class="example-full-width mat-form-field-space-remove" appearance="standard">
                                <input 
                                    type="text"
                                    matInput
                                    placeholder="Search Group"
                                    required
                                    [formControl]="group"
                                    [matAutocomplete]="autoGroup"
                                    (keyup.enter)="enterGroup()"
                                    (click)="preloadGroupdata()"
                                    (change)="handleEmptyGroupInput($event)">
                                <mat-autocomplete 
                                    #autoGroup="matAutocomplete"
                                    [displayWith]="displayGroupFn"
                                    (optionSelected)="optionGroupSelected($event.option)">
                
                                    <mat-option *ngIf="groupisLoadingBox" class="is-loading">
                                        <mat-spinner diameter="50"></mat-spinner>
                                    </mat-option>
                
                                    <ng-container *ngIf="!groupisLoadingBox && allGroupLists.length > 0">
                                        <mat-option 
                                            *ngFor="let option of filteredGroupOptions | async" 
                                            [value]="option">
                                            {{option.title}}
                                        </mat-option>
                                    </ng-container>
                
                                    <ng-container *ngIf="!groupisLoadingBox && allGroupLists.length == 0">
                                        <mat-option>
                                        <span>{{getLang('norecord', 'No Record')}}</span>
                                        </mat-option>
                                    </ng-container>
                
                                </mat-autocomplete>
                
                            </mat-form-field>

                            
                
                            <div 
                                [hidden]="form.get('group').valid || (form.get('group').pristine && !submitted)"
                                class="text-danger">
                                <small *ngIf="form.get('group').hasError('required')" class="error-label">
                                    {{getLang('groupisrequired', 'Group is Required')}}
                                </small>
                            </div>

                        </div>
                        <div >
                            <button 
                                (click)="addNewGroup()"
                                mat-button
                                type="button"
                                class="btn btn-primary btn-simple btn-square-plr"
                                matTooltip="Add Group">
                                <i class="material-icons help-font">add</i>
                            </button>
                        </div>

                        </div>
                            
                
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-12" *ngIf="newCustomer && this.assign == 'individual'">
                <div class="row membroz-row">

                    <div class="col-md-2 membroz-col">
                        <mat-form-field class="mat-form-field-space-remove example-full-width" appearance="standard">
                            <input 
                                matInput 
                                placeholder="First Name"
                                formControlName="customerfirstname">
                        </mat-form-field>
                        <div 
                            [hidden]="form.get('customerfirstname').valid || (form.get('customerfirstname').pristine && !submitted)"
                            class="text-danger">
                            <small *ngIf="form.get('customerfirstname').hasError('required')" class="error-label">
                                {{getLang('FirstNameisrequired', 'First Name is Required')}}
                            </small>
                        </div>
                    </div>

                    <div class="col-md-2 membroz-col">
                        <mat-form-field class="mat-form-field-space-remove example-full-width" appearance="standard">
                            <input 
                                matInput 
                                placeholder="Last Name"
                                formControlName="customerlastname">
                        </mat-form-field>
                        <div 
                            [hidden]="form.get('customerlastname').valid || (form.get('customerlastname').pristine && !submitted)"
                            class="text-danger">
                            <small *ngIf="form.get('customerlastname').hasError('required')" class="error-label">
                                {{getLang('LastNameisrequired', 'Last Name is Required')}}
                            </small>
                        </div>
                    </div>

                    <div class="col-md-3 membroz-col">
                        
                        <div class="input-group align-items-center">
                            <mat-form-field 
                                class="mat-form-field-space-remove example-full-width" appearance="standard">
                                <input 
                                    matInput 
                                    placeholder="Customer Email"
                                    formControlName="customeremail">
                            </mat-form-field>
                            
                        </div>

                        <div 
                            [hidden]="form.get('customeremail').valid || (form.get('customeremail').pristine && !submitted)"
                            class="text-danger">

                            <small *ngIf="form.get('customeremail').hasError('required') && !form.get('customeremail').hasError('email')" class="error-label">
                                {{getLang('Emailisrequired', 'Email is Required')}}
                            </small>

                            <small *ngIf="form.get('customeremail').hasError('email') && !form.get('customeremail').hasError('required')">
                                Please enter a valid email address
                            </small>

                        </div>

                        

                    </div>

                    <div class="col-md-3 membroz-col">
                        
                        <mat-form-field class="mat-form-field-space-remove example-full-width" appearance="standard">
                            <input 
                                matInput 
                                placeholder="Mobile Number"
                                formControlName="customermobile">
                        </mat-form-field>

                        
                        <div 
                            [hidden]="form.get('customermobile').valid || (form.get('customermobile').pristine && !submitted)"
                            class="text-danger">

                            <small *ngIf="form.get('customermobile').hasError('required')" class="error-label">
                                {{getLang('Mobileisrequired', 'Mobile is Required')}}
                            </small>

                        </div>


                    </div>

                    <div class="col-md-2 membroz-col" >
                        <button 
                        (click)="submitAddNewCustomer()"
                        class="btn btn-primary" 
                        type="button" 
                        matTooltip="Save"
                        [disabled]="disableBtn" >
                        <i class="material-icons">save</i> 
                        </button>
                        <button 
                            (click)="canceladdNewCustomer()"
                            class="btn btn-default ml-2" 
                            type="button"
                            matTooltip="Cancel"
                            [disabled]="disableBtn">
                            <i class="material-icons">close</i> 
                        </button>
                        
                    </div>

                </div>
            </div>

            
            <div class="col-sm-12" *ngIf="newGroup && this.assign == 'group'">
                <div class="row membroz-row">
            
                    <div class="col-md-5 membroz-col">
                        <mat-form-field class="mat-form-field-space-remove example-full-width" appearance="standard">
                            <input matInput placeholder="Group name" formControlName="groupname">
                        </mat-form-field>
                        <div [hidden]="form.get('groupname').valid || (form.get('groupname').pristine && !submitted)"
                            class="text-danger">
                            <small *ngIf="form.get('groupname').hasError('required')" class="error-label">
                                {{getLang('FirstNameisrequired', 'Group Name is Required')}}
                            </small>
                        </div>
                    </div>
                    <div class="col-md-5 membroz-col">
                        <mat-form-field class="mat-form-field-space-remove example-full-width" appearance="standard">
                            <input matInput placeholder="Group size" formControlName="groupsize">
                        </mat-form-field>
                        <div [hidden]="form.get('groupsize').valid || (form.get('groupsize').pristine && !submitted)"
                            class="text-danger">
                            <small *ngIf="form.get('groupsize').hasError('required')" class="error-label">
                                {{getLang('FirstNameisrequired', 'Group Size is Required')}}
                            </small>
                        </div>
                    </div>
                    <div class="col-md-2 membroz-col">
                        <button (click)="submitAddNewGroup()" class="btn btn-primary" type="button" matTooltip="Save"
                            [disabled]="disableBtn">
                            <i class="material-icons">save</i>
                        </button>
                        <button (click)="canceladdNewGroup()" class="btn btn-default ml-2" type="button" matTooltip="Cancel"
                            [disabled]="disableBtn">
                            <i class="material-icons">close</i>
                        </button>
                
                    </div>
            
                </div>
            
            
               
            
            </div>


            <div class="col-sm-12">
                <div class="row">
                    <div class="col-sm-12">
                        <label class="col-form-label">
                            {{getLang('service', 'Service')}}
                            <span class="text-danger">*</span>
                        </label>

                        <mat-form-field class="example-full-width mat-form-field-space-remove" appearance="standard"  >
                            <input 
                                type="text"
                                matInput
                                required
                                [formControl]="service"
                                [matAutocomplete]="auto"
                                (keyup.enter)="enter()"
                                (click)="preloaddata()"
                                (change)="handleEmptyInput($event)">

                            <mat-autocomplete 
                                #auto="matAutocomplete"
                                [displayWith]="displayFn"
                                (optionSelected)="optionSelected($event.option)">

                                <mat-option *ngIf="serviceisLoadingBox" class="is-loading">
                                    <mat-spinner diameter="50"></mat-spinner>
                                </mat-option>

                                <ng-container *ngIf="!serviceisLoadingBox && serviceLists.length > 0">
                                    <mat-optgroup *ngFor="let group of filteredServices | async" [label]="group.name" class="mat-optgroup-media">
                                        
                                        <mat-option  class="mat-option-normal mat-option-child-border"
                                            *ngFor="let child of group.children" 
                                            [value]="child">
                                            <div class="media py-2 member-profile-item service-list cursor-pointer" >
                                                

                                                <i class="material-icons mt-2 mr-2 rounded-icon"> list_alt </i>

                                                <div class="media-body">
                                                    
                                                    <div class="d-flex">
                                                        <div class="flex-grow-1"> 
                                                            <div class="font-500 mb-1">
                                                                <span>{{child?.title}}</span> 
                                                                <small *ngIf="child && child.services"> | Service: {{child?.services?.length}}</small>    
                                                            </div>
                                                        </div>
                                                        <div class="fc-today-button font-500">{{child?.charges | myCurrencyPipe}}</div>
                                                    </div>
                                                    <div class="d-flex">
                                                        <div class="flex-grow-1"> {{child.type == 'service' ? group.name : child.type}} </div>
                                                        <div class="fc-today-button font-14" *ngIf="child?.duration">{{child?.duration}} Min.</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </mat-option>
                                    </mat-optgroup>
                                </ng-container>

                                <ng-container *ngIf="!serviceisLoadingBox && serviceLists.length == 0">
                                    <mat-option>
                                    <span>{{getLang('norecord', 'No Record')}}</span>
                                    </mat-option>
                                </ng-container>

                            </mat-autocomplete>


                        </mat-form-field>

                        <div 
                            [hidden]="form.get('service').valid || (form.get('service').pristine && !submitted)"
                            class="text-danger">
                            <small *ngIf="form.get('service').hasError('required')" class="error-label">
                                {{getLang('serviceisrequired', 'Service is Required')}}
                            </small>
                        </div>
                    </div>

                </div>
            </div>

        </div>


        <div 
            fxLayout="row" 
            *ngIf="busy" 
            fxLayoutAlign="space-around center" 
            style="height:100%; position: relative; margin-left: 50%; margin-right: 50%;">
            <mat-spinner diameter="50" strokeWidth="5"></mat-spinner>
        </div>

        <ng-container *ngIf="appointmentLists && appointmentLists.length > 0 && form.controls.appointments?.value && form.controls.appointments?.value.length > 0">
        
            <div 
                class="mt-3" 
                formArrayName="appointments" 
                *ngFor="let item of form.controls.appointments?.value; let i = index; let last = last; trackBy:trackByFn">

                <ng-container *ngIf="this.appointmentLists[i]" [formGroupName]="i">

                    <mat-accordion class="custom-mpd-half example-headers-align mat-accordion-header-auto">

                        <mat-expansion-panel [expanded]="step === i" (opened)="setStep(i)" hideToggle="true">
                            <mat-expansion-panel-header>
                                <mat-panel-title>
                                    {{this.form.get('appointments').at(i).get('title')?.value}}
                                </mat-panel-title>
                                <mat-panel-description class="d-flex justify-content-start">
                                    

                                    <ng-container>
                                        <span class="color-gray-dark font-16 d-inline-block mr-xl-3 mr-3">
                                            {{this.form.get('appointments').at(i).get('date').value | date}}
                                        </span>

                                        <span class="color-gray-dark font-16 d-inline-block mr-xl-3 mr-3">
                                            {{getTimeSlot(i, form.get('appointments').at(i).get('trackingId').value)}}
                                        </span>

                                        <span class="color-gray-dark font-16 d-inline-block mr-xl-3 mr-3">
                                            {{form.get('appointments').at(i).get('staff')?.value?.fullname}}
                                        </span>

                                        <span class="color-gray-dark font-16 d-inline-block mr-xl-3 mr-3">
                                            <i 
                                                class="material-icons" 
                                                style="color: red;" 
                                                *ngIf="this.appointmentLists[i].notAvailable">warning</i>
                                        </span>

                                    </ng-container>
                                    
                                    
                                </mat-panel-description>
                            </mat-expansion-panel-header>

                            <div class="row">
                                
                                <div class="col-sm-6">
            
                                    <label class="col-form-label">
                                        {{getLang('date', 'Date')}}
                                        <span class="text-danger">*</span>
                                    </label>

                                    <mat-form-field class="example-full-width mat-form-field-space-remove">
                                        <input 
                                            matInput 
                                            formControlName="date"
                                            [min]="minDate" 
                                            [matDatepicker]="picker1"
                                            [matDatepickerFilter]="myFilter"
                                            (dateChange)="dateChange(i, $event)">
                                        <mat-datepicker-toggle matSuffix [for]="picker1"></mat-datepicker-toggle>
                                        <mat-datepicker #picker1></mat-datepicker>
                                    </mat-form-field>

                                    <div
                                        [hidden]="this.form.get('appointments').at(i).get('date').valid || (this.form.get('appointments').at(i).get('date').pristine && !submitted)"
                                        class="text-danger">
                                        <small *ngIf="this.form.get('appointments').at(i).get('date').hasError('required')" class="error-label">
                                            {{getLang('dateisrequired', 'Date is Required')}}
                                        </small>
                                    </div>

                                </div>
                                
                                <div class="col-sm-6">
                                    
                                    <label class="col-form-label">
                                        {{getLang('time', 'Time')}}
                                        
                                        <span class="text-danger">*</span>
                                    </label>

                                    <div class="row">

                                        <div class="col-sm-5">
                                            <mat-form-field class="example-full-width mat-form-field-space-remove">

                                                <mat-select 
                                                    formControlName="starttime" 
                                                    (selectionChange)="starttimeChange(i, form.get('appointments').at(i).get('trackingId').value, $event.value)">

                                                    <mat-option>Select Start Time</mat-option>

                                                    <mat-option 
                                                        [value]="starttimeslot.id" 
                                                        *ngFor="let starttimeslot of this.appointmentLists[i].timeslotLists">
                                                        {{starttimeslot.starttime}}
                                                    </mat-option>

                                                </mat-select>

                                            </mat-form-field>
                
                                            <div
                                                [hidden]="form.get('appointments').at(i).get('starttime').valid || (form.get('appointments').at(i).get('starttime').pristine && !submitted)"
                                                class="text-danger">
                                                <small *ngIf="form.get('appointments').at(i).get('starttime').hasError('required')" class="error-label">
                                                    {{getLang('starttimeisrequired', 'starttime is Required')}}
                                                </small>
                                            </div>
                                        </div>
                                        <div class="col-sm-2">
                                            <label class="col-form-label"> To </label>
                                        </div>
                                        <div class="col-sm-5">
                                            <mat-form-field class="example-full-width mat-form-field-space-remove">
                                                <mat-select 
                                                    formControlName="endtime"
                                                    (selectionChange)="endtimeChange(i, form.get('appointments').at(i).get('trackingId').value, $event.value)">
                                                    <mat-option>Select End Time</mat-option>
                                                    <mat-option [value]="endtimeslot.id" *ngFor="let endtimeslot of this.appointmentLists[i].timeslotLists">
                                                        {{endtimeslot.starttime}}
                                                    </mat-option>
                                                </mat-select>
                                            </mat-form-field>

                                            <div
                                                [hidden]="form.get('appointments').at(i).get('endtime').valid || (form.get('appointments').at(i).get('endtime').pristine && !submitted)"
                                                class="text-danger">
                                                <small *ngIf="form.get('appointments').at(i).get('endtime').hasError('required')" class="error-label">
                                                    {{getLang('endtimeisrequired', 'endtime is Required')}}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-sm-6" *ngIf="this.appointmentLists[i].staffLists && this.appointmentLists[i].staffLists.length > 0">
                                    
                                    <label class="col-form-label">
                                        {{getLang('staff', 'Staff')}}
                                        <span class="text-danger">*</span>
                                    </label> 

                                    <div class="input-group align-items-center">

                                        <app-appointment-hosts-lists
                                            class="flex-grow-1 "
                                            *ngIf="this.appointmentLists[i].staffvisible"
                                            formControlName="staff"
                                            [options]="this.appointmentLists[i].staffLists"
                                            [dbvalue]="this.appointmentLists[i].staffdbvalue"
                                            [index]="i"
                                            (notavailable)="onItemNotAvailable(i, $event)">
                                        </app-appointment-hosts-lists>

                                        <ng-continer 
                                            [ngClass]="this._loginUserBranch && this._loginUserBranch.appointmentsetting && this._loginUserBranch.appointmentsetting.enableLockStafftoRoom && this._loginUserBranch.appointmentsetting.enableLockStafftoRoom == 'No' ? 'd-none' : ''">

                                            <div class="d-flex align-items-center">
                                
                                                <mat-checkbox 
                                                    class="example-margin" 
                                                    formControlName="islock"> 
                                                </mat-checkbox>
            
                                                
                                                <i class="material-icons mt-minus-3">lock</i>
            
                                                <div
                                                    [hidden]="form.get('appointments').at(i).get('islock').valid || (form.get('appointments').at(i).get('islock').pristine && !submitted)"
                                                    class="text-danger">
                                                    <small *ngIf="form.get('appointments').at(i).get('islock').hasError('required')" class="error-label">
                                                        {{getLang('islockisrequired', 'islock is Required')}}
                                                    </small>
                                                </div>
                                            </div>
                                        </ng-continer>
                                   </div>
                                    <div
                                        [hidden]="form.get('appointments').at(i).get('staff').valid || (form.get('appointments').at(i).get('staff').pristine && !submitted)"
                                        class="text-danger">

                                        <small *ngIf="form.get('appointments').at(i).get('staff').hasError('required')" class="error-label">
                                            {{getLang('staffisrequired', 'Staff is Required')}}
                                        </small>

                                    </div>

                                    <div class="text-danger" *ngIf="this.appointmentLists[i].staffnotAvailable">
                                        <small class="error-label">
                                            Staff is not available
                                        </small>
                                    </div>

                                </div>
                                
                                <div class="col-sm-6" *ngIf="this.appointmentLists[i].supportstaffLists && this.appointmentLists[i].supportstaffLists.length > 0">
            
                                    <label class="col-form-label">
                                        {{getLang('support staff', 'Support Staff')}}
                                    </label> 

                                    <mat-form-field class="mat-form-field-space-remove example-full-width" >

                                        <mat-select 
                                            (selectionChange)="supportStaffChangeMethod($event, i)"
                                            formControlName="supportstaff" 
                                            multiple>

                                            <mat-select-trigger>
                                                {{form.get('appointments').at(i).get('supportstaff').value ? getDisplayName(i, form.get('appointments').at(i).get('supportstaff').value[0], 'supportstaffLists', 'fullname') : ''}}
                                                <span *ngIf="form.get('appointments').at(i).get('supportstaff').value?.length > 1" class="example-additional-selection">
                                                    (+{{form.get('appointments').at(i).get('supportstaff').value.length - 1}} {{form.get('appointments').at(i).get('supportstaff').value?.length === 2 ? 'other' : 'others'}})
                                                </span>
                                            </mat-select-trigger>

                                            <mat-option 
                                                *ngFor="let item of this.appointmentLists[i].supportstaffLists" 
                                                [value]="item._id">
                                                {{item.fullname}}
                                            </mat-option>

                                        </mat-select>
                                    </mat-form-field>
                                    <div
                                        [hidden]="form.get('appointments').at(i).get('supportstaff').valid || (form.get('appointments').at(i).get('supportstaff').pristine && !submitted)"
                                        class="text-danger">
                                        <small *ngIf="form.get('appointments').at(i).get('supportstaff').hasError('required')" class="error-label">
                                            {{getLang('supportstaffisrequired', 'Support Staff is Required')}}
                                        </small>
                                    </div>

                                    <div class="text-danger" *ngIf="this.appointmentLists[i].supportstaffnotAvailable">
                                        <small class="error-label">
                                            Support Staff is not available
                                        </small>
                                    </div>

                                </div>

                                <div class="col-sm-6" *ngIf="this.appointmentLists[i].products && this.appointmentLists[i].products.length > 0">
            
                                    <label class="col-form-label">
                                        {{getLang('products', 'Products')}}
                                    </label> 

                                    <mat-form-field class="mat-form-field-space-remove example-full-width" >

                                        <mat-select 
                                            formControlName="products" 
                                            multiple>

                                            <mat-select-trigger>
                                                {{form.get('appointments').at(i).get('products').value ? getDisplayName(i, form.get('appointments').at(i).get('products').value[0], 'products', 'itemname') : ''}}
                                                <span *ngIf="form.get('appointments').at(i).get('products').value?.length > 1" class="example-additional-selection">
                                                    (+{{form.get('appointments').at(i).get('products').value.length - 1}} {{form.get('appointments').at(i).get('products').value?.length === 2 ? 'other' : 'others'}})
                                                </span>
                                            </mat-select-trigger>

                                            <mat-option 
                                                *ngFor="let item of this.appointmentLists[i].products" 
                                                [value]="item._id">
                                                {{item.itemname}}
                                            </mat-option>

                                        </mat-select>
                                    </mat-form-field>

                                    <div
                                        [hidden]="form.get('appointments').at(i).get('products').valid || (form.get('appointments').at(i).get('products').pristine && !submitted)"
                                        class="text-danger">
                                        <small *ngIf="form.get('appointments').at(i).get('products').hasError('required')" class="error-label">
                                            {{getLang('productsisrequired', 'products is Required')}}
                                        </small>
                                    </div>

                                </div>

                                <div class="col-sm-6" *ngIf="this.appointmentLists[i].equipments && this.appointmentLists[i].equipments.length > 0">
            
                                    <label class="col-form-label">
                                        {{getLang('equipments', 'Equipments')}}
                                    </label> 

                                    <mat-form-field class="mat-form-field-space-remove example-full-width" >

                                        <mat-select 
                                            (selectionChange)="equipmentsChangeMethod($event, i)"
                                            formControlName="equipments" 
                                            multiple>

                                            <mat-select-trigger>
                                                {{form.get('appointments').at(i).get('equipments').value ? getDisplayName(i, form.get('appointments').at(i).get('equipments').value[0], 'equipments', 'title') : ''}}
                                                <span *ngIf="form.get('appointments').at(i).get('equipments').value?.length > 1" class="example-additional-selection">
                                                    (+{{form.get('appointments').at(i).get('equipments').value.length - 1}} {{form.get('appointments').at(i).get('equipments').value?.length === 2 ? 'other' : 'others'}})
                                                </span>
                                            </mat-select-trigger>

                                            <mat-option 
                                                *ngFor="let item of this.appointmentLists[i].equipments" 
                                                [value]="item._id">
                                                {{item.title}}
                                            </mat-option>

                                        </mat-select>
                                    </mat-form-field>

                                    <div
                                        [hidden]="form.get('appointments').at(i).get('equipments').valid || (form.get('appointments').at(i).get('equipments').pristine && !submitted)"
                                        class="text-danger">

                                        <small *ngIf="form.get('appointments').at(i).get('equipments').hasError('required')" class="error-label">
                                            {{getLang('equipmentsisrequired', 'Equipments is Required')}}
                                        </small>


                                    </div>

                                    <div class="text-danger" *ngIf="this.appointmentLists[i].equipmentnotAvailable">
                                        <small class="error-label">
                                            Equipments is not available
                                        </small>
                                    </div>

                                </div>

                                <div class="col-sm-6" *ngIf="this.appointmentLists[i].rooms && this.appointmentLists[i].rooms.length > 0">

                                    <label class="col-form-label">
                                        {{getLang('Room', 'Room')}}
                                    </label>

                                    <app-appointment-resource-lists 
                                        *ngIf="this.appointmentLists[i].roomvisible"
                                        formControlName="rooms"
                                        [options]="this.appointmentLists[i].rooms"
                                        [dbvalue]="this.appointmentLists[i].roomsdbvalue"
                                        (notavailable)="onResourceItemNotAvailable($event)">
                                    </app-appointment-resource-lists>
                        
                                    <div
                                        [hidden]="form.get('appointments').at(i).get('rooms').valid || (form.get('appointments').at(i).get('rooms').pristine && !submitted)"
                                        class="text-danger">
                                        <small *ngIf="form.get('appointments').at(i).get('rooms').hasError('required')" class="error-label">
                                            {{getLang('roomsisrequired', 'rooms is Required')}}
                                        </small>
                                    </div>
                                </div>

                                <div class="col-sm-12" [ngClass]="isEdit ? 'd-none' : ''">
                                        
                                    <mat-checkbox 
                                        class="example-margin" 
                                        formControlName="schedule"
                                        (change)="onScheduleChanged(i, $event)"> 
                                    </mat-checkbox>

                                    <label class="col-form-label">
                                        {{getLang('recurring', 'Recurring')}}
                                    </label>
                        
                                    <div
                                        [hidden]="form.get('appointments').at(i).get('schedule').valid || (form.get('appointments').at(i).get('schedule').pristine && !submitted)"
                                        class="text-danger">
                                        <small *ngIf="form.get('appointments').at(i).get('schedule').hasError('required')" class="error-label">
                                            {{getLang('scheduleisrequired', 'schedule is Required')}}
                                        </small>
                                    </div>
                                </div>

                                <div class="col-sm-6" *ngIf="form.get('appointments').at(i).get('schedule').value == true">
                                    <label class="col-form-label"></label>
                        
                                    <mat-form-field>
                                        <mat-select
                                            name="recurringtype"
                                            formControlName="recurringtype"
                                            (ngModelChange)="onRecurringChanged(i, $event)">
                                            <mat-option *ngFor="let item of recurringtypeLists" [value]="item.id"> {{item.name}} </mat-option>
                                        </mat-select>
                                    </mat-form-field>

                                    <div
                                        [hidden]="form.get('appointments').at(i).get('recurringtype').valid || (form.get('appointments').at(i).get('recurringtype').pristine && !submitted)"
                                        class="text-danger">
                                        <small *ngIf="form.get('appointments').at(i).get('recurringtype').hasError('required')" class="error-label">
                                            {{getLang('recurringtypeisrequired', 'Recurring Type is Required')}}
                                        </small>
                                    </div>
                                
                                </div>

                                <div class="col-sm-12" *ngIf="form.get('appointments').at(i).get('schedule').value == true && this.appointmentLists[i]?.appointmentscheduleList && this.appointmentLists[i].appointmentscheduleList.length == 0">
                                    <div class="d-flex align-items-center">
                                        <div class="pr-3">
                                            <span *ngIf="form.get('appointments').at(i).get('recurringtype').value == 'daily'">
                                                {{getLang('repeatdailyat', 'Repeat daily at')}} 
                                                &nbsp; {{getTimeSlot(i, form.get('appointments').at(i).get('trackingId').value)}}
                                                &nbsp; {{getLang('starting', 'starting')}} 
                                                &nbsp; {{form.get('appointments').at(i).get('date').value | date: 'mediumDate'}} 
                                                &nbsp; {{getLang('for', 'for')}}  
                                            </span>
                                            <span *ngIf="form.get('appointments').at(i).get('recurringtype').value == 'weekly'">
                                                {{getLang('repeatevery', 'Repeat every')}} 
                                                &nbsp; {{getDayName(date)}} 
                                                &nbsp; {{getLang('at', 'at')}} 
                                                &nbsp; {{getTimeSlot(i, form.get('appointments').at(i).get('trackingId').value)}}
                                                &nbsp; {{form.get('appointments').at(i).get('date').value | date: 'mediumDate'}}
                                                &nbsp; {{getLang('for', 'for')}} 
                                            </span>
                                            <span *ngIf="form.get('appointments').at(i).get('recurringtype').value == 'monthly'">
                                                {{getLang('repeatthe', 'Repeat the')}} 
                                                &nbsp; {{getDay(date)}} 
                                                &nbsp; {{getLang('ofeverymonthat', 'of every month at')}} 
                                                &nbsp; {{getTimeSlot(i, form.get('appointments').at(i).get('trackingId').value)}}
                                                &nbsp; {{getLang('starting', 'starting')}} 
                                                &nbsp; {{form.get('appointments').at(i).get('date').value | date: 'mediumDate'}} 
                                                &nbsp; {{getLang('for', 'for')}}   
                                            </span>
                                        </div>
                        
                                        <div class="col-lg-2 col-md-3 col-4 pr-3">
                                            <mat-form-field >
                                                <mat-select
                                                    name="recurringoccurance"
                                                    formControlName="recurringoccurance">
                                                    <mat-option *ngFor="let item of recurringoccuranceLists" [value]="item"> {{item}} </mat-option>
                                                </mat-select>
                                            </mat-form-field>

                                            <div
                                                [hidden]="form.get('appointments').at(i).get('recurringoccurance').valid || (form.get('appointments').at(i).get('recurringoccurance').pristine && !submitted)"
                                                class="text-danger">
                                                <small *ngIf="form.get('appointments').at(i).get('recurringoccurance').hasError('required')" class="error-label">
                                                    {{getLang('recurringtypeisrequired', 'Recurring Type is Required')}}
                                                </small>
                                            </div>

                                        </div>

                                        <div>
                                            {{getLang('times', 'Times')}}.
                                        </div>
                                    </div>
                                </div>

                                <div class="col-sm-12" *ngIf="form.get('appointments').at(i).get('schedule').value == true && this.appointmentLists[i].appointmentscheduleList && this.appointmentLists[i].appointmentscheduleList.length == 0">
                
                                    <div class="d-flex mb-3 justify-content-end">
                                        <button 
                                            type="button" 
                                            class="btn btn-primary" 
                                            (click)="addtime(i)">
                                            {{getLang('addschedule', 'Add Schedule')}} 
                                        </button>
                                    </div>
                                </div>

                                <div class="col-sm-12" *ngIf="form.get('appointments').at(i).get('schedule').value == true && this.appointmentLists[i].appointmentscheduleList && this.appointmentLists[i].appointmentscheduleList.length > 0">
                                    <div class="col-sm-3">
                        
                                    </div>
                                    <div class="col-sm-9">
                                        <ul class="list-group">
                                            <li 
                                                class="list-group-item d-flex justify-content-between align-items-center"
                                                *ngFor="let itemAppoint of this.appointmentLists[i].appointmentscheduleList"
                                                [ngClass]="isHoliday(itemAppoint) ? '' : 'list-group-item-danger'">
                                                
                                                {{getTimeSlot(i, form.get('appointments').at(i).get('trackingId').value)}}
                                                on 
                                                {{itemAppoint | date: 'mediumDate'}}
                                                

                                                <span class="cursor-pointer">
                                                    <a class="delete" (click)="removeDate(i, itemAppoint)">{{getLang('remove', 'Remove')}}</a>
                                                </span>
                                                
                                            </li>
                                        </ul>
                                    </div>
                                    
                                </div>

                                <div class="col-sm-12" [ngClass]="this.globalfunctionpermissions.includes('Online Meet') ? '' : 'd-none'">
                        
                                    <mat-checkbox 
                                        class="example-margin" 
                                        formControlName="onlinemeet"
                                        (change)="showOptions(i, $event)"> 
                                    </mat-checkbox>

                                    <label class="col-form-label">
                                        {{getLang('onlinemeet', 'Online Meet')}}
                                    </label>

                                    <div
                                        [hidden]="form.get('appointments').at(i).get('onlinemeet').valid || (form.get('appointments').at(i).get('onlinemeet').pristine && !submitted)"
                                        class="text-danger">
                                        <small *ngIf="form.get('appointments').at(i).get('onlinemeet').hasError('required')" class="error-label">
                                            {{getLang('onlinemeetisrequired', 'Onlinemeet is Required')}}
                                        </small>
                                    </div>
                                </div>

                                <div class="col-sm-12" *ngIf="form.get('appointments').at(i).get('onlinemeet').value == true">
                                    <label class="col-form-label">
                                        {{getLang('enterurl', 'Enter URL')}}
                                        <span class="text-danger">*</span>
                                    </label>
                        
                                    <mat-form-field class="example-full-width mat-form-field-space-remove" >
                                        <input 
                                        matInput
                                        type="text"
                                        class="example-margin"
                                        formControlName="onlinemeeturl">
                                    </mat-form-field>
                        
                                    <div
                                        [hidden]="form.get('appointments').at(i).get('onlinemeeturl').valid || (form.get('appointments').at(i).get('onlinemeeturl').pristine && !submitted)"
                                        class="text-danger">
                                        <small *ngIf="form.get('appointments').at(i).get('onlinemeeturl').hasError('required')" class="error-label">
                                            {{getLang('onlinemeeturlisrequired', 'onlinemeeturl is Required')}}
                                        </small>
                                    </div>
                                </div>

                                <div class="col-sm-12">
            
                                    <label class="col-form-label">
                                        {{getLang('notes', 'Note')}}
                                    </label>

                                    <mat-form-field class="mat-form-field-space-remove example-full-width">
                                        <input 
                                            matInput 
                                            formControlName="note">
                                    </mat-form-field>

                                    <div
                                        [hidden]="this.form.get('appointments').at(i).get('note').valid || (this.form.get('appointments').at(i).get('note').pristine && !submitted)"
                                        class="text-danger">
                                        <small *ngIf="this.form.get('appointments').at(i).get('note').hasError('required')" class="error-label">
                                            {{getLang('noteisrequired', 'note is Required')}}
                                        </small>
                                    </div>

                                </div>

                                <div class="col-sm-12 pt-2">
                        
                                    <mat-checkbox 
                                        class="example-margin" 
                                        formControlName="confirmed"> 
                                    </mat-checkbox>

                                    <label class="col-form-label">
                                        {{getLang('markasconfirmed', 'Mark as Confirmed')}}
                                    </label>

                                    <div
                                        [hidden]="form.get('appointments').at(i).get('confirmed').valid || (form.get('appointments').at(i).get('confirmed').pristine && !submitted)"
                                        class="text-danger">
                                        <small *ngIf="form.get('appointments').at(i).get('confirmed').hasError('required')" class="error-label">
                                            {{getLang('confirmedisrequired', 'confirmed is Required')}}
                                        </small>
                                    </div>
                                </div>

                            </div>

                            <div class="row">
                                
                                <div class="col-sm-6 text-left">
                                    <button 
                                        type="button" 
                                        mat-raised-button
                                        color="danger" 
                                        class="btn btn-danger"
                                        (click)="removeGroup(i)">
                                        <i class="material-icons">delete</i> Delete
                                    </button>

                                    <button 
                                        (click)="addService(i)"
                                        *ngIf="!this.isEdit && !this.isReschedule"
                                        class="btn btn-success" 
                                        type="button">
                                        <i class="material-icons">add</i> {{getLang('addanoterservice', 'Add Another Service')}}
                                    </button>
                                </div>
                                
                                <div class="col-sm-6 text-right">
                                    
                                    <ng-container>

                                        <!-- <button 
                                            [disabled]="this.appointmentLists[i].valid"
                                            type="button" 
                                            mat-button 
                                            class="btn btn-success" 
                                            (click)="checkAvailability(i)">
                                            <i class="material-icons">save</i> 
                                            Check Availability
                                            <span *ngIf="this.appointmentLists[i].pendingValidation"> (searching)</span>
                                        </button> -->

                                        <ng-container *ngIf="!last">
                                            <button 
                                                [disabled]="!this.appointmentLists[i].valid"
                                                type="button" 
                                                mat-button 
                                                class="btn btn-primary" 
                                                (click)="nextStep(i)">
                                                <i class="material-icons">save</i> 
                                                Save & Next
                                                <span *ngIf="this.appointmentLists[i].pendingValidation"> (searching)</span>
                                            </button>
                                        </ng-container>

                                        <ng-container *ngIf="last">
                                            
                                            <button 
                                                [disabled]="!this.appointmentLists[i].valid"
                                                type="button" 
                                                mat-button 
                                                class="btn btn-primary" 
                                                (click)="saveAndSubmit(i)">
                                                <i class="material-icons">save</i> 
                                                Save & Submit
                                                <span *ngIf="this.appointmentLists[i].pendingValidation"> (searching)</span>
                                            </button>
                                        </ng-container>
                                    </ng-container>
                                </div>
                            </div>
                        </mat-expansion-panel>

                    </mat-accordion>
                </ng-container>
            </div>

        </ng-container>

        <div class="row mt-3">
            
            <div class="col-sm-6 text-left">
                

            </div>
            <div class="col-sm-6 text-right">
                <button 
                    (click)="cancel()"
                    class="btn btn-default" 
                    type="button"
                    [disabled]="disableBtn || busy">
                    <i class="material-icons">close</i> {{getLang('cancel', 'Cancel')}}
                </button>
                <button 
                    id="submit"
                    class="btn btn-primary ml-2" 
                    type="submit" 
                    [disabled]="disableBtn || busy">
                    <i class="material-icons">save</i> {{getLang('save', 'Save')}}
                </button>
            </div>
                
        </div>

    </div>

</form>